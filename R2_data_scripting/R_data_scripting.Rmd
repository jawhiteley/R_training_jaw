---
title: "A Short Introduction to Working With Data in R"
author: "Jonathan Whiteley"
date: "`r Sys.Date()`"
output: 
  beamer_presentation: 
    latex_engine: xelatex # ensures certain characters (like '^') are rendered correctly
    theme: Boadilla
    colortheme: default
    highlight: ../shared/my_tango.theme
    slide_level: 2
    toc: false
    keep_tex: yes
    includes:
      in_header: "../shared/preamble-include.tex"
fontsize: 11pt
urlcolor: darkblue   # defined in LaTeX preamble (in_header includes, above)
linkcolor: darkblue  # defined in LaTeX preamble (in_header includes, above)
params:
  is_virtual: TRUE    # is this presentation for a virtual (T) or in-person (F) environment?
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(width = 60)  # to fit output on slides
```

## Prerequisites

-   Access to a copy of the [![](`r file.path(R.home("doc"), "html", "logo.jpg")`){height=1em}](https://www.r-project.org) software

    -   i.e., a "binary executable"

    -   Go to [*www.r-project.org*](https://www.r-project.org) to get a copy, \
        or ask your system administrator.

- Tidyverse packages installed on the same system as $\R$

  - Please run this command in $\R$ *before* the workshop:
    ```{r install_tidyverse, eval=FALSE}
    install.packages("tidyverse")
    ```

-   Knowledge of common mathematical operations: arithmetic, logarithms, etc.

-   Knowledge of basic $\R$ concepts, such as *variables*, *objects*, *operators*, *functions*, *packages*, etc.

    -   This is covered in the first workshop: "A Gentle Introduction to R"

<!-- R logo: ![](`r file.path(R.home("doc"), "html", "logo.jpg")`){height=1em} -->


## Learning Objectives

- Load tabular data into R
- Explore data to check that it was loaded correctly
- Export data from R to external files
- Data frames
- Clean data
  - Add & change columns
  - Edit values systematically
  - Change data types
- Tidy data
  - Change the _shape_ of a data frame
- Re-use code, reproducible results, automated reports
  - Scripts
  - R Markdown, R Notebooks

# Welcome

## Pop Quiz

\annote{\fade{We will review these \textit{at the end}, so you can see how much you have learned.}}

+ If multiple packages have functions with the same name,
  how can you specify which one to use?
+ Does $\R$ store data in memory or temporary files?
+ What is the limit to the size of objects and datasets that can be loaded into $\R$?
+ TRUE or FALSE: $\R$ has rules and conventions for naming functions
+ TRUE or FALSE: if you use one package from the `tidyverse`, you have to use all of them.

```{r welcome, echo=FALSE, results='asis'}
if (params$is_virtual) {
  cat("\\ 
  \n### Answer in the chat:
  \n
  \nWhat is your favourite emoji?  Why do you like to use it so much?
  ")
}
```


## Introductions

- Name
- Pronouns
- Job title, role
- _optional_: a favourite childhood treat or candy?

<!-- -->

- What are you hoping to learn most in today's workshop?




# Loading data into $\R$

## 

<!--
- working directory
- read.csv (read.table)
  - local Example File
- downloading data from the internet (to a temp dir)
  - the same local file, directly from the URL on GitHub
  - CANSIM / NDMr / other package?
-->



# Exploring your data

## Data frames

<!--
- Data frames (review)
- head, str, names, plot?
- View / R Studio Environment pane
- Know Your Data
-->


# Saving data outside $\R$

<!--
- write.csv
- Extras: exporting to Excel?
- .Rdata files?
-->

# Re-using your code: scripts and other files

<!--
+ What is a script? Why use a script?
  - Make a simple script that does what we've done so far?
+ The comment character '#'
- never use setwd() in a script!
+ Flow-control
  - if () else
  - for () loop
+ defining your own functions
  - anonymous functions? (*introduce when it becomes relevant*, later)
  * write a custom function for comparing values in two vectors with NAs
    - http://www.cookbook-r.com/Manipulating_data/Comparing_vectors_or_factors_with_NA/
    - https://stackoverflow.com/questions/37610056/how-to-treat-nas-like-values-when-comparing-elementwise-in-r
+ Style Guides
  - https://style.tidyverse.org/syntax.html
  - https://google.github.io/styleguide/Rguide.html
+ Rmd, Notebooks? (save for later?)\
  - Brief mention, demo
-->




# The `tidyverse` collection of packages

## The `tidyverse`

``` r
install.packages("tidyverse")
help(package="tidyverse")
```

- The [`tidyverse`](https://www.tidyverse.org/) is an "opinionated" [collection of packages](https://www.tidyverse.org/packages/) that are designed to work together.

- All packages share an underlying design philosophy, grammar, and data structures.
  <!-- - _unlike core $\R$ and other packages_ -->

Today, we will focus on a few of the core `tidyverse` packages for loading, cleaning, and manipulating data:

* [readr](https://readr.tidyverse.org/), [readxl](https://readxl.tidyverse.org/) for **loading** data
<!-- * [tibble](https://tibble.tidyverse.org/) for a 'modern' version of `data.frame`s that behave slightly differently (but are compatible with `data.frame`s). -->
* [dplyr](https://dplyr.tidyverse.org/) for **manipulating** data (values)
* [tidyr](https://tidyr.tidyverse.org/) for **rearranging** data
* [stringr](https://stringr.tidyverse.org/) for working with **strings**


## A 'pipe' operator  {.shrink}

:::::: {.columns .onlytextwidth align=center}
::: {.column width="38%"}

![["La Trahison des Images" ("The Treachery of Images")](https://en.wikipedia.org/wiki/The_Treachery_of_Images) or "Ceci\ n'est pas une pipe" ("This\ is not a pipe") by René Magritte. 
<!-- [Image from Wikipedia](https://en.wikipedia.org/wiki/The_Treachery_of_Images#/media/File:MagrittePipe.jpg). -->
](images/MagrittePipe.jpg)

\centering

[![`magrittr` logo.](images/magrittr_logo.png){height=25%}](https://magrittr.tidyverse.org/)

:::
::: {.column width="58%"}

- The [`magrittr`](https://magrittr.tidyverse.org/) [package](https://cran.r-project.org/package=magrittr) (included with [`tidyverse`](https://www.tidyverse.org/packages/#program)) provides a "forward-pipe operator"<!--[^not-a-pipe]-->:

  ``` r
  %>%    # ?magrittr::`%>%`
  ```

- The `magrittr` package is automatically loaded when loading most `tidyverse` packages (e.g., `tidyr`, `dplyr`, `ggplot2`), as these packages all use this operator extensively.

  - It is often unnecessary to load `magrittr` separately, unless you are **not** using these other packages.

:::
::::::

<!-- [^not-a-pipe]: Although it is a 'pipe' operator, it does not contain a 'pipe' character (`|`), hence the reference to René Magritte's surrealist painting. -->

::: notes
`magrittr` logo downloaded from: https://github.com/tidyverse/magrittr/blob/main/man/figures/logo.png
:::


## `magrittr`'s 'forward-pipe' operator

- `%>%`{.r} allows you to pass results from an expression on the left-hand side (LHS) as an argument (usually the first) to a *function call* on the right-hand side (RHS).  

+--------------------------------+--------------------------------+
| This expression ...            | is equivalent to:              |
+================================+================================+
| ``` r                          | ``` r                          |
| x %>% f()                      | f(x)                           |
| ```                            | ```                            |
+--------------------------------+--------------------------------+
| ``` r                          | ``` r                          |
| x %>% f(y)                     | f(x, y)                        |
| ```                            | ```                            |
+--------------------------------+--------------------------------+
| ``` r                          | ``` r                          |
| x %>% f(y, z = .)              | f(y, z = x)                    |
| ```                            | ```                            |
+--------------------------------+--------------------------------+
| ``` r                          | ``` r                          |
| x %>% f %>% g %>% h            | h(g(f(x)))                     |
| ```                            | ```                            |
+--------------------------------+--------------------------------+

- This can make code easier to read, as expressions are written and evaluated from _left to right_, rather than from _inside to outside_ nested parentheses.


## $\R$ now has a 'native' pipe operator

- A pipe operator was introduced in base $\R$ in v4.1 (May 2021)[^R4.1]:

  ``` r
  |>    # ?pipeOp
  ```

- It was inspired by the "forward pipe operator" introduced by `magrittr`, but is more streamlined. 
  See these links for details:

  - [Differences between the base R and magrittr pipes](https://www.tidyverse.org/blog/2023/04/base-vs-magrittr-pipe/)
  - "[Understanding the native R pipe |>](https://towardsdatascience.com/understanding-the-native-r-pipe-98dea6d8b61b)"

- Because it is so new, most code examples online still use '`%>%`{.r}' from `magrittr`.

- This document will use '`%>%`{.r}' in the examples, 
  for consistency and because it was designed 
  to work with other `tidyverse` functions.

- But '`|>`{.r}' might work well for you in simple cases,  
  without having to load any additional packages.

[^R4.1]: https://cran.r-project.org/bin/windows/base/old/4.1.0/NEWS.R-4.1.0.html


## Pipes: exercise




# Clean data

<!--
+ filter()
  - package::function notation (to distinguish from other functions named 'filter')
  - near()?
  - duplicates: find, drop [after merging?]
+ select()
+ mutate()
+ editing values systematically
  - ifelse()
  - case_when()
+ summarize()
+ combining datasets
  - rbind / bind_rows
  - cbind / bind_cols
  - join() [mention merge()?]
  - exercise: summarize a dataset and merge back with original for calculation?
    - or just group_by() & mutate()
+ sorting; arrange()
  - group_by()
+ exercise: clean some values in Example File loaded earlier.
-->




# Tidy data

## Tidy datasets

> 
> > Happy families are all alike; every unhappy family is unhappy in its own way 
> 
> — Leo Tolstoy 
  \
  \
> Like families, tidy datasets are all alike but every messy dataset is messy in its own way.  
> 
> --- Hadley Wickham (doi: [10.18637/jss.v059.i10](https://doi.org/10.18637/jss.v059.i10))


- Tidy datasets provide a standardized way to link the *structure* of a dataset (its physical layout) with its *semantics* (its meaning).

  - [`tidyr` vignette](https://cran.r-project.org/web/packages/tidyr/vignettes/tidy-data.html)




# Review

## Exercise

<!--
in pairs, or small groups:
write a script (or two companion scripts) that
- load a series of files in a folder
  - ue existing dataset, split up by a grouping variable (or year, etc.)
- cleans each one to be consistent (in a function)
- combines them into a single dataset
- re-arrange (pivot) the final dataset
- compare to reference file to test success?
  - have another team / person write a script to do this?
- export & save the file

One option is to have one person or group introduce some 'errors'
and have another try to fix them, but it's easy to introduce
very difficult issues to solve, so this can be risky and time-consuming.
Might work best with a few parameters to limit the kinds of changes that can be made.
-->


## [Quiz](#pop-quiz) Review

<!-- copy questions from [Pop Quiz][], above. -->


::: notes
`## Answers (for discussion)`

:::




# Backmatter

## Other packages to look at

- [`data.table`](https://rdatatable.gitlab.io/data.table/): a high-performance version of `data.frame` with few dependencies.

- [`purrr`](https://purrr.tidyverse.org/) (part of the `tidyverse`): functional programming (FP) tools for working with functions and vectors.  
  - Replace `for` loops with code that is more efficient and easier to read.


## Writing to Microsoft Excel^TM^ files  {.shrink}
<!-- move to `extras`? -->

Packages that can write to Excel files:

- [`xlsx`](https://github.com/colearendt/xlsx): read, write, format Excel\ 2007 (`.xlsx`) and Excel\ 97/2000/XP/2003 (`.xls`) files.
  - Depends on Java and the `rJava` package

- [`XLConnect`](https://github.com/miraisolutions/xlconnect): comprehensive and cross-platform R package for manipulating Microsoft Excel files (`.xlsx` & `.xls`) from within R.
  - Requires a Java Runtime Environment (JRE)

- [`openxlsx`](https://ycphs.github.io/openxlsx/index.html): simplified creation of Excel `.xlsx` files (**not** `.xls`).
  - _No dependency_ on Java

- [`writexl`](https://docs.ropensci.org/writexl/): portable, light-weight data frame to **xlsx** exporter. 
  - No Java or Excel required

### !

I recommend _avoiding_ exporting data to Excel files if possible.
`csv` files are easier to read to & write from, and can be read by a wider variety of software (they are more portable).  
Automated reports can be produced with R Markdown and output to a variety of more portable formats (pdf, HTML, etc.) instead. 

::: notes
As seen here, there are several packages for working with Excel files, with different advantages and disadvantages: you may have to do some testing to find the best fit for your situation.

I personally prefer the `openxlsx` package, because in my experience, the dependency on Java can be difficult to get working and unreliable.  But I have no experience with `writexl`, which is newer and possibly faster than the others.  
The main trade-off is the openxlsx cannot write to `.xls` files (Excel 97/2000/XP/2003 format) and has fewer formatting options than other packages --- but if you need that much formatting, why not produce a formatted report with R Markdown?
:::


## References

Cheatsheets:

- [readr/readxl](https://rstudio.github.io/cheatsheets/html/data-import.html)
- [Data transformation with dplyr](https://rstudio.github.io/cheatsheets/html/data-transformation.html)
- [Data tidying with tidyr](https://rstudio.github.io/cheatsheets/html/tidyr.html)

::: notes
https://cran.rapporter.net/doc/contrib/de_Jonge+van_der_Loo-Introduction_to_data_cleaning_with_R.pdf
https://mountainmath.ca/canssi/#1
https://mountainmath.github.io/canadian_data/

https://stackoverflow.com/questions/3452086/getting-path-of-an-r-script
https://stackoverflow.com/questions/47044068/get-the-path-of-current-script
https://cran.r-project.org/web/packages/this.path/this.path.pdf
:::
